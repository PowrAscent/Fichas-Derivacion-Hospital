<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Modificar Ficha de Derivación — HRR</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

        <style>
            /* Paleta HRR */
            :root {
                --hrr-dark-green: rgb(105, 135, 27);
                --hrr-light-green: rgb(157, 189, 72);
                --hrr-gradient: linear-gradient(90deg, var(--hrr-dark-green), var(--hrr-light-green));
                --hrr-dark: #1e1f22;
            }

            html, body {
                height: 100%;
                font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
                background: linear-gradient(180deg, rgba(105, 135, 27, 0.12), rgba(157, 189, 72, 0.12)), #f6f8f5;
            }

            .navbar {
                box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
                background-color: var(--hrr-dark);
            }

            .brand-accent {
                background-image: var(--hrr-gradient);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                font-weight: 700;
            }

            /* Contenedor central */
            .main-wrap {
                min-height: calc(100vh - 64px);
                display: grid;
                place-items: center;
                padding: 3rem 1rem;
            }

            .card-hrr {
                border: 1px solid rgba(0, 0, 0, 0.06);
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
                padding: 2rem;
            }

            .hero-title {
                font-size: clamp(1.25rem, 2.2vw + 0.8rem, 1.75rem);
                margin: 0;
                color: #2b2f26;
            }

            .hero-subtitle {
                color: #5c6352;
            }

            .btn-gradient {
                background-image: var(--hrr-gradient);
                color: #fff;
                border: none;
            }

            .btn-gradient:hover {
                filter: brightness(0.95);
                color: #fff;
            }

            .center-buttons {
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                margin: 0 auto;
            }

            /* Estilo para campos de solo lectura */
            .read-only-field {
                background-color: #e9ecef;
                opacity: 1; /* Asegurar que no se vea atenuado */
            }

			.badge-hrr {
				background: rgba(105, 135, 27, 0.12);
				color: var(--hrr-dark-green);
				border: 1px solid rgba(105, 135, 27, 0.25);
			}

            /* Footer */
            .footer {
                color: #6b7260;
            }
        </style>
    </head>
    {% load tz %}
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center gap-2" href="/panel/" aria-label="Ir al menú principal">
                    <i class="bi bi-hospital fs-4 text-success"></i>
                    <span>Hospital Regional de <span class="brand-accent">Rancagua</span></span>
                </a>
                <div class="ms-auto d-flex align-items-center gap-3">
                    <span class="navbar-text text-white-50 small">
                        Bienvenido, <strong>{{ request.session.correo }}</strong> — Rol: <span class="badge rounded-pill badge-hrr">{{ request.session.rol }}</span>
                    </span>
                    <a href="/logout/" class="btn btn-outline-light btn-sm" aria-label="Cerrar sesión">
                        <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
                    </a>
                </div>
            </div>
        </nav>

        <main class="main-wrap">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12 col-md-10 col-lg-7">
                        <div class="card card-hrr">
                            <h1 class="hero-title">Modificar Ficha de Derivación #{{ derivacion.id }}</h1>
                            <p class="hero-subtitle mb-4">Realice las correcciones o ajustes necesarios a la ficha.</p>

                            {% if r %}
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <h5>{{ r }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            {% endif %}

                            <h5 class="mb-3 text-secondary border-bottom pb-2"><i class="bi bi-person-fill me-2"></i> Datos del Paciente</h5>

                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control read-only-field" disabled value="{{ derivacion.paciente.nombre }}" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">RUT</label>
                                    <input type="text" class="form-control read-only-field" disabled value="{{ derivacion.paciente.rut }}" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Comorbilidades</label>
                                    <div>
                                        {% for com in derivacion.paciente.comorbilidades.all %}
                                            <span class="badge text-bg-warning me-1">{{ com.nombre }}</span>
                                        {% empty %}
                                            <span class="text-muted small">Ninguna registrada.</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <form method="POST" action="/modificar/{{ derivacion.id }}/">
                                {% csrf_token %}

                                <input type="hidden" name="derivacion_id" value="{{ derivacion.id }}" />

                                <h5 class="mb-3 mt-4 text-secondary border-bottom pb-2"><i class="bi bi-pencil-square me-2"></i> Campos a Modificar</h5>

                                <div class="mb-3">
                                    <label for="fecha_ingreso" class="form-label">Fecha de Ingreso</label>
                                    <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" required value="{{ derivacion.fecha_ingreso|date:'Y-m-d' }}" />
                                </div>

                                <div class="mb-3">
                                    <label for="motivo_derivacion" class="form-label">Motivo de Derivación</label>
                                    <textarea class="form-control" id="motivo_derivacion" name="motivo_derivacion" rows="3" required>{{ derivacion.motivo_derivacion }}</textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="prestacion_requerida" class="form-label">Prestación Requerida</label>
                                    <input type="text" class="form-control" id="prestacion_requerida" name="prestacion_requerida" required value="{{ derivacion.prestacion_requerida }}" />
                                </div>

                                <div class="mb-3">
                                    <label for="gravedad" class="form-label">Gravedad</label>
                                    <select class="form-select" id="gravedad" name="gravedad" required>
                                        {% for val, label in derivacion.GRAVEDAD_CHOICES %}
                                            <option value="{{ val }}" {% if val == derivacion.gravedad %}selected{% endif %}>{{ label }}</option>
                                        {% empty %}
                                            <option value="ALTA" {% if 'ALTA' == derivacion.gravedad %}selected{% endif %}>Alta</option>
                                            <option value="MEDIA" {% if 'MEDIA' == derivacion.gravedad %}selected{% endif %}>Media</option>
                                            <option value="BAJA" {% if 'BAJA' == derivacion.gravedad %}selected{% endif %}>Baja</option>
                                            <option value="CRITICA" {% if 'CRITICA' == derivacion.gravedad %}selected{% endif %}>Crítica</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="evaluacion" class="form-label">Evaluación</label>
                                    <textarea class="form-control" id="evaluacion" name="evaluacion" rows="3" required>{{ derivacion.evaluacion }}</textarea>
                                </div>

                                <div class="center-buttons">
                                    <button type="submit" class="btn btn-gradient px-4 py-2">Guardar Modificaciones</button>
                                </div>

                                <div class="center-buttons mt-3">
                                    <a href="/listar/" class="btn btn-outline-secondary px-4 py-2">
                                        <i class="bi bi-arrow-left me-2"></i> Volver al Listado
                                    </a>
                                </div>
                            </form>
                        </div>

                        <p class="text-center mt-4 mb-0 footer small">
                            © <span id="y"></span> Hospital Regional de Rancagua — Área de Gestión Clínica
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <script>
            // Año dinámico del footer
            document.getElementById('y').textContent = new Date().getFullYear();
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>