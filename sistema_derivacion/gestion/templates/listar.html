<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Listar Derivaciones — HRR</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

	<style>
		/* Paleta HRR */
		:root {
			--hrr-dark-green: rgb(105, 135, 27);
			--hrr-light-green: rgb(157, 189, 72);
			--hrr-gradient: linear-gradient(90deg, var(--hrr-dark-green), var(--hrr-light-green));
			--hrr-dark: #1e1f22;
		}

		html,
		body {
			height: 100%;
			font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans',
				'Liberation Sans', sans-serif;
			background: linear-gradient(180deg, rgba(105, 135, 27, 0.12), rgba(157, 189, 72, 0.12)), #f6f8f5;
		}

		.navbar {
			box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
			background-color: var(--hrr-dark);
		}

		.brand-accent {
			background-image: var(--hrr-gradient);
			-webkit-background-clip: text;
			background-clip: text;
			color: transparent;
			font-weight: 700;
		}

		/* Contenedor central */
		.main-wrap {
			min-height: calc(100vh - 64px);
			display: grid;
			place-items: center;
			padding: 3rem 1rem;
		}

		.card-hrr {
			border: 1px solid rgba(0, 0, 0, 0.06);
			border-radius: 16px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
			padding: 2rem;
		}

		.hero-title {
			font-size: clamp(1.25rem, 2.2vw + 0.8rem, 1.75rem);
			margin: 0;
			color: #2b2f26;
		}

		.hero-subtitle {
			color: #5c6352;
		}

		.btn-gradient {
			background-image: var(--hrr-gradient);
			color: #fff;
			border: none;
		}

		.btn-gradient:hover {
			filter: brightness(0.95);
			color: #fff;
		}

		.center-buttons {
			display: flex;
			justify-content: center;
			align-items: center;
			text-align: center;
			margin: 0 auto;
		}

		.badge-hrr {
			background: rgba(105, 135, 27, 0.12);
			color: var(--hrr-dark-green);
			border: 1px solid rgba(105, 135, 27, 0.25);
		}

		/* Footer */
		.footer {
			color: #6b7260;
		}
	</style>
</head>
{% load tz %}

<body>
	<nav class="navbar navbar-expand-lg navbar-dark">
		<div class="container">
			<a class="navbar-brand d-flex align-items-center gap-2" href="/menuA/" aria-label="Ir al menú principal">
				<i class="bi bi-hospital fs-4 text-success"></i>
				<span>Hospital Regional de <span class="brand-accent">Rancagua</span></span>
			</a>
			<div class="ms-auto d-flex align-items-center gap-3">
				<span class="navbar-text text-white-50 small">
					Bienvenido, <strong>{{ request.session.correo }}</strong> — Rol:
					<span class="badge rounded-pill badge-hrr">{{ request.session.rol }}</span>
				</span>
				<a href="/logout/" class="btn btn-outline-light btn-sm" aria-label="Cerrar sesión">
					<i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
				</a>
			</div>
		</div>
	</nav>

	<main class="main-wrap">
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-12 col-md-10 col-lg-10">
					<div class="card card-hrr p-4">
						<h1 class="hero-title">Listado de Derivaciones</h1>
						<p class="hero-subtitle mb-4">
							Utilice el campo de búsqueda para filtrar las fichas por el **RUT del paciente**.
						</p>

						<form method="GET" action="/listar/" class="mb-4">
							<div class="row g-2 align-items-end">
								<div class="col-12 col-sm-8 col-md-9">
									<label for="rut" class="form-label">RUT del paciente</label>
									<div class="input-group">
										<input type="text" class="form-control" id="rut" name="rut"
											placeholder="Ingrese el RUT del paciente (ej: 12345678-9)"
											value="{{ rut_buscado }}" />
										<button class="btn btn-gradient" type="submit"><i class="bi bi-search me-1"></i>
											Buscar</button>

										{% if rut_buscado %}
										<a href="/listar/" class="btn btn-outline-danger" title="Limpiar filtro">
											<i class="bi bi-x-circle"></i> Limpiar
										</a>
										{% endif %}
									</div>
								</div>

								<div class="col-12 col-sm-4 col-md-3 d-flex gap-2 d-sm-none">
									<a href="/menuA/" class="btn btn-outline-secondary w-100">Volver</a>
								</div>
							</div>
						</form>

						<h5 class="mb-3">Resultados</h5>

						<div class="table-responsive">
							<table class="table table-striped table-hover mb-0">
								<thead>
									<tr>
										<th>ID</th>
										<th>RUT</th>
										<th>Paciente</th>
										<th>Fecha Ingreso</th>
										<th>Gravedad</th>
										<th class="d-none d-lg-table-cell">Motivo derivación</th>
										<th>Estado Derivacion</th>
										<th>Acciones</th>
									</tr>
								</thead>
								<tbody>
									{% for derivacion in derivaciones %}
									<tr>
										<td>{{ derivacion.id }}</td>
										<td><strong>{{ derivacion.paciente.rut }}</strong></td>
										<td>{{ derivacion.paciente.nombre }}</td>
										<td>{{ derivacion.fecha_ingreso|date:"d-m-Y" }}</td>

										<td>
											<span
												class="badge {% if derivacion.gravedad == 'ALTA' or derivacion.gravedad == 'CRITICA' %}text-bg-danger {% elif derivacion.gravedad == 'MEDIA' %}text-bg-warning {% else %}text-bg-success{% endif %}">
												{{ derivacion.gravedad }}
											</span>
										</td>

										<td class="d-none d-lg-table-cell">
											{{ derivacion.motivo_derivacion|truncatechars:50 }}
										</td>

										<td>
											{% if derivacion.pendiente %}
											<span class="badge text-bg-warning">Pendiente / En Revisión</span>
											{% else %}
											<span class="badge text-bg-success">Aprobada</span>
											{% endif %}
										</td>

										<td>
											<a class="btn btn-outline-info btn-sm me-1"
												href="/derivacion/{{ derivacion.id }}/detalle/">
												<i class="bi bi-file-text"></i>
											</a>
											<a class="btn btn-outline-warning btn-sm"
												href="/modificar/{{ derivacion.id }}/">
												<i class="bi bi-pencil"></i>
											</a>
										</td>
									</tr>
									{% endfor %}
								</tbody>

							</table>
						</div>

						<!-- PAGINACIÓN -->
						{% if page_obj.has_other_pages %}
						<nav aria-label="Page navigation" class="mt-4">
							<ul class="pagination justify-content-center">

								{% if page_obj.has_previous %}
								<li class="page-item">
									<a class="page-link"
										href="?page={{ page_obj.previous_page_number }}{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}">
										Anterior
									</a>
								</li>
								{% else %}
								<li class="page-item disabled"><span class="page-link">Anterior</span></li>
								{% endif %}

								{% for num in page_obj.paginator.page_range %}
								{% if num == page_obj.number %}
								<li class="page-item active">
									<span class="page-link">{{ num }}</span>
								</li>
								{% else %}
								<li class="page-item">
									<a class="page-link"
										href="?page={{ num }}{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}">
										{{ num }}
									</a>
								</li>
								{% endif %}
								{% endfor %}

								{% if page_obj.has_next %}
								<li class="page-item">
									<a class="page-link"
										href="?page={{ page_obj.next_page_number }}{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}">
										Siguiente
									</a>
								</li>
								{% else %}
								<li class="page-item disabled"><span class="page-link">Siguiente</span></li>
								{% endif %}

							</ul>
						</nav>
						{% endif %}
						<!-- FIN PAGINACIÓN -->

						<div class="center-buttons mt-4 d-flex justify-content-center gap-3">
							<a href="/panel/" class="btn btn-outline-secondary px-4 py-2">
								<i class="bi bi-arrow-left me-2"></i> Volver al menú principal
							</a>
						</div>

						<p class="text-center mt-4 mb-0 footer small">
							© <span id="y"></span> Hospital Regional de Rancagua — Área de Gestión Clínica
						</p>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script>
		// Año dinámico del footer
		document.getElementById('y').textContent = new Date().getFullYear();
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>